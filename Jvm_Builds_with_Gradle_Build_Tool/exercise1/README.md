## JVM Builds with Gradle Build Tool - Exercise 1

<p align="left">
<img width="10%" height="10%" src="https://user-images.githubusercontent.com/120980/174325546-8558160b-7f16-42cb-af0f-511849f22ebc.png">
</p>

This is a hands-on exercise to go along with the
**JVM Builds with Gradle Build Tool** training module. In this exercise
you will get familiar with the following topics:

* Modifying SourceSet directories
* Using SourceSet outputs
* Creating SourceSets
* Exploring SourceSet tasks

---
### Prerequisites

* JDK 1.8+ and Gradle build tool installed
    * https://gradle.org/install/
* IntelliJ IDE - Optional but recommended
    * https://www.jetbrains.com/idea/download/

### Picking a Language for the Exercises

The lab has different subprojects for the following JVM languages:

* Java
* Groovy
* Kotlin
* Scala

You can pick which subproject you want to work with for the exercises,
or if you have time you can do the exercises with more than one subproject.
Most of the changes you make will be in the
`buildSrc/src/main/kotlin/shared-build-conventions.gradle.kts` file - take
a moment to get familiar with this file.

The exercises will refer to locations such as
`<subproject>/src/main/java/com/gradle/lab/<source>`. The `<subproject>` will
be the directory of the subproject you decide to work with, and the `<source>`
will be the source file(s) there.

---
### Code Generation Task

Open the Gradle project in the `lab` folder. In IntelliJ you can do this by
opening the `settings.gradle.kts` file as a Gradle project.

Inspect the `<subproject>/src/main/java/com/gradle/lab/<source>` file. You
will notice it depends on a `Message` class which isn't found.

<p align="center">
<img width="60%" height="60%" src="https://user-images.githubusercontent.com/120980/189351788-2de9cf1e-5498-438c-9e04-6f7911a45342.png">
</p>

This class exists in `mlCodeGenTemplate/com/gradle/lab/Message.java`.

<p align="center">
<img width="35%" height="35%" src="https://user-images.githubusercontent.com/120980/189352260-621203f9-e7e6-4271-be78-1a72d85a246d.png">
</p>

For the purposes of this  exercise let's pretend that this file is going to be
edited and partially generated by a machine learning tool. Let's create the task
that will then output the final source file for our consumption.

Add the following task to
`buildSrc/src/main/kotlin/shared-build-conventions.gradle.kts`:

```kotlin
tasks.register<Copy>("generateMlCode") {
    from(layout.projectDirectory.dir("../mlCodeGenTemplate"))
    into(layout.buildDirectory.dir("generated/sources/mlCode"))
}
```

This will create a task that will "generate" the required source files
and make them available in the `build` directory for use. Go ahead and
run the task to see the source generation:

```bash
./gradlew :<subproject>:generateMlCode
```

<p align="center">
<img width="40%" height="40%" src="https://user-images.githubusercontent.com/120980/189352740-279942c8-3ee3-4f5e-a54c-ee78cf87879e.png">
</p>

**Note** that it is recommended that any artifacts produced by tasks
including generated sources are put in the `build` directory.

### Updating the `main` SourceSet

To view the current configuration of the `main` SourceSet run:

```bash
./gradlew :<subproject>:sourceSetsInfo
```

Notice the srcDirs for the `main` SourceSet. For example, in the `groovy`
subproject you will see:

<p align="center">
<img width="35%" height="35%" src="https://user-images.githubusercontent.com/120980/189353015-1e92758c-3a11-4347-ae7a-5c9da11de7d4.png">
</p>

We need to register the generated sources to make them available
to the rest of the sources. To do this, edit
`buildSrc/src/main/kotlin/shared-build-conventions.gradle.kts`
and add configuration to include the outputs of the `generateMlCode` task
as part of the main SourceSet.

```kotlin
sourceSets {
    main {
        java {
            // Make your changes here.
        }
    }
}
```

*Hint:* You want to reference the *task named* `generateMlCode`. For additional
hints you can refer to the following documentation:
* [Adding entires to SourceSets](https://docs.gradle.org/current/userguide/building_java_projects.html#sec:custom_java_source_set_paths)
* [Linking outputs to inputs](https://docs.gradle.org/current/userguide/more_about_tasks.html#sec:link_output_dir_to_input_files)

If you get stuck you can refer to the
[solution](solution/buildSrc/src/main/kotlin/shared-build-conventions.gradle.kts#L68).

Now when you inspect the `main` SourceSet you will see the additional generated
sources:

```bash
./gradlew :<subproject>:sourceSetsInfo
```

<p align="center">
<img width="40%" height="40%" src="https://user-images.githubusercontent.com/120980/189353525-8520eba7-e23a-4e27-b373-006cfc0e0297.png">
</p>

Now Gradle can use the additional sources and the compile task will succeed.
You can now run the application:

```bash
./gradlew :<subproject>:run
```

<p align="center">
<img width="40%" height="40%" src="https://user-images.githubusercontent.com/120980/191465483-7de54758-b1ef-4c15-8099-a4f24f633808.png">
</p>

### Creating a New SourceSet

Inspect the source files under `<subproject>/src/extra`. Let's create a
SourceSet for these. Use the `sourceSets.create` method to register a
new SourceSet. Assign this SourceSet to a variable.

```kotlin
val extraSrc = ...
```

Now if you inspect the SourceSets you will see this new one show up:

```bash
./gradlew :<subproject>:sourceSetsInfo
```

<p align="center">
<img width="35%" height="35%" src="https://user-images.githubusercontent.com/120980/189354307-b4193b8a-5545-42d1-bcd5-bd61ef58e9b9.png">
</p>

Add a dependency for `joda-time:joda-time:2.11.1` associated with this
SourceSet.
*Hint:* Look at the `impl dependency configuration` in the output above.

If you get stuck you can refer to the
[solution](solution/buildSrc/src/main/kotlin/shared-build-conventions.gradle.kts#L76).

### Adding a Task for the new SourceSet

You can compile the new SourceSet by running the `compileExtraJava`
task:

```bash
./gradlew :<subproject>:compileExtraJava
```

Let's add a task to run the new sources which has a main class.
Register a new task of type `JavaExec` and set the classpath
and main class.

*Hint:* The classpath will be the output and runtime classpath
of the `extraSrc` SourceSet.

```kotlin
tasks.register... {
    classpath = ...
    mainClass.set(...)
}
```

If you get stuck you can refer to the
[solution](solution/buildSrc/src/main/kotlin/shared-build-conventions.gradle.kts#L80).

You can now run the source for the new SourceSet:

```bash
./gradlew :java:runExtra
```

<p align="center">
<img width="50%" height="50%" src="https://user-images.githubusercontent.com/120980/191478592-3a20ec94-f6cf-4ffa-8036-65f27efcc7a6.png">
</p>

<p align="right">
<a href="https://github.com/gradle/build-tool-training-exercises/tree/main/Jvm_Builds_with_Gradle_Build_Tool/exercise2">Exercise 2 >></a>
</p>
